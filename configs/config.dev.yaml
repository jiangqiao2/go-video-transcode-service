# 转码服务开发环境配置
server:
  host: "0.0.0.0"
  port: 8082
  mode: debug
  read_timeout: 60s
  write_timeout: 60s

# 数据库配置
# Docker中运行的服务访问宿主机上的MySQL
database:
  host: "host.docker.internal"
  port: 3306  # 使用实际的MySQL容器端口
  username: "root"
  password: "root123"
  database: transcode_service
  charset: utf8mb4
  parse_time: true
  loc: Local
  max_idle_conns: 10
  max_open_conns: 100
  conn_max_lifetime: 3600s

# Redis配置
# Docker中运行的服务访问宿主机上的Redis
redis:
  host: host.docker.internal
  port: 6379
  password: ""
  db: 1
  pool_size: 10
  min_idle_conns: 5
  dial_timeout: 5s
  read_timeout: 3s
  write_timeout: 3s
  enable_tls: false

# Kafka配置
# Docker中运行的服务访问宿主机上的Kafka
kafka:
  enabled: true
  client_id: "transcode-service"
  group_id: "transcode-service-group"
  bootstrap_servers:
    - "host.docker.internal:29092"
  topics:
    transcode_tasks: "transcode.tasks"
  commit_on_decode_error: true
  commit_on_process_error: false

# MinIO配置
# Docker中运行的服务访问宿主机上的RustFS
minio:
  endpoint: host.docker.internal:9000
  access_key: rustfsadmin
  secret_key: rustfsadmin
  use_ssl: false
  bucket_name: uploads

rustfs:
  endpoint: "host.docker.internal:9000"
  access_key: "rustfsadmin"
  secret_key: "rustfsadmin"
  use_ssl: false

# 对外访问配置
public:
  storage_base: "http://localhost:8000"

# 转码配置
transcode:
  # FFmpeg配置
  ffmpeg:
    binary_path: "/usr/local/bin/ffmpeg"
    temp_dir: "/tmp/transcode"
    max_concurrent_tasks: 16
    timeout: 3600s
    video_codec: "h264_nvenc"
    hardware_accel: "cuda"
    video_preset: "fast"
    threads: 2
    use_hardware_decode: true
    decoder_threads: 1
    cuvid_surfaces: 16
  
  # 输出格式配置
  output_formats:
    - name: "720p"
      resolution: "1280x720"
      bitrate: "2000k"
      codec: "libx264"
      preset: "medium"
    - name: "480p"
      resolution: "854x480"
      bitrate: "1000k"
      codec: "libx264"
      preset: "medium"
    - name: "360p"
      resolution: "640x360"
      bitrate: "500k"
      codec: "libx264"
      preset: "fast"
    - name: "1080p"
      resolution: "1920x1080"
      bitrate: "4000k"
      codec: "libx264"
      preset: "medium"

# Worker配置
worker:
  enabled: true
  worker_id: "worker-001"
  heartbeat_interval: 10s
  task_poll_interval: 3s
  max_concurrent_tasks: 10
  queue_capacity: 100
  shutdown_grace_period: 30s

# 调度器配置
scheduler:
  enabled: true
  task_poll_interval: 5s
  worker_heartbeat_timeout: 30s
  max_retry_count: 3
  cleanup_interval: 300s

# JWT配置
jwt:
  secret: "transcode-service-jwt-secret-key-2024"
  expire_time: 24h
  refresh_expire_time: 168h

# 日志配置
log:
  level: debug
  format: json
  output: stdout
  file_path: "/var/log/transcode-service/app.log"
  max_size: 100
  max_backups: 7
  max_age: 30
  compress: true

# gRPC server configuration
grpc_server:
  host: "0.0.0.0"
  port: 9092

grpc_client:
  timeout: 30s
  max_recv_msg_size: 4194304
  max_send_msg_size: 4194304
  retry_times: 3

dependencies:
  # upload-service和video-service在本地运行
  upload_service:
    service_name: "upload-service"
    address: ""
    host: "host.docker.internal"
    port: 9093
    timeout: 30s
  video_service:
    service_name: "video-service"
    address: ""
    host: "host.docker.internal"
    port: 9094
    timeout: 30s


# Service registry configuration
# Docker中运行的服务注册时使用host.docker.internal作为可达地址
service_registry:
  service_name: "transcode-service"
  service_id: "transcode-service-1"
  register_host: "host.docker.internal"
  ttl: 30s
  refresh_interval: 10s
